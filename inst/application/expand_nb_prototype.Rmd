---
title: 
output: html_notebook
---
 
 
### Setup
 
```{r setup}
 
suppressWarnings(suppressMessages({
  library(knitr)
  library(kableExtra)
  library(htmltools)
  library(tidyverse)
  library(ExPanDaR)
}))
 
get_suitable_vars <- function(t, s, v) {
  if(t == "factor") {
    return(which(v$type == "factor" | sapply(s, function (x) length(unique(na.omit(x))) <= factor_cutoff)))
  } else if (t == "2level") {
    return(which(sapply(s, function (x) length(unique(na.omit(x))) == 2)))
  } else return(which(v$type == t))
}
 
create_var_categories <- function(s, v) {
  for (type in c("cs_id", "ts_id", "numeric", "logical", "factor", "2level")) {
    cand <- get_suitable_vars(type, s, v)
    assign(paste0("l", type), data.frame(
      col = cand,
      name = v$var_name[cand],
      stringsAsFactors = FALSE
    ), envir = parent.env(environment()))
  }
}
 
```
 
 
### Sample creation
 
This step reads the data provided by the user and generates the sample for the analysis.
 
```{r create_sample}
 
create_sample <- function(df, df_def) {
  # Set infinite numerical variables to NA
  df[, df_def$var_name[df_def$type == "numeric"]] <-
    lapply(df[, df_def$var_name[df_def$type == "numeric"]], function(x) ifelse(is.finite(x), x, NA))
   
  # Delete numerical variables that only contain NAs
  all_na_vars <- sapply(df, function (x) all(is.na(x)))
  df_def <- df_def[!all_na_vars,]
  df <- df[, df_def$var_name]
   
  # Drop observations that are NA in variables that are not allowed to
  df <- df[complete.cases(df[,as.character(df_def$var_name[which(df_def$can_be_na == FALSE)])]),]
   
  # Subset if requested by user
  if ((uc$subset_factor != "Full Sample") & (uc$subset_value != "All"))
    df <- df[which(df[, uc$subset_factor] == uc$subset_value),]
   
  # Balance sample if requested by user
  if (uc$balanced_panel) {
    df <- group_by_at(df, vars(one_of(df_def$var_name[df_def$type  == "cs_id"]))) %>%
      mutate(nobs = n())
    max_nobs <- length(levels(as.data.frame(df[, df_def$var_name[df_def$type  == "ts_id"]])[,1]))
    bal_df <- as.data.frame(select(filter(df, nobs == max_nobs), -nobs))
    if (nrow(bal_df) > 0) df <- as.data.frame(bal_df)
    else {
      uc$balanced_panel <<- FALSE
      warning("Balancing panel yields empty sample. Deselecting option.")
    }
  }
  
  # Outlier treatment as requested by user
  nums <- df_def$var_name[df_def$type == "numeric"]
  if (uc$outlier_factor == "None") 
    group <- NULL
  else 
    group = df[,uc$outlier_factor]
   
  if (uc$outlier_treatment == 2) df[,nums] <- treat_outliers(df[,nums], 0.01, FALSE, group)
  if (uc$outlier_treatment == 3) df[,nums] <- treat_outliers(df[,nums], 0.05, FALSE, group)
  if (uc$outlier_treatment == 4) df[,nums] <- treat_outliers(df[,nums], 0.01, TRUE, group)
  if (uc$outlier_treatment == 5) df[,nums] <- treat_outliers(df[,nums], 0.05, TRUE, group)
   
  # Create lists that identify variables that conform to certain types
  df <- droplevels(df)
  create_var_categories(df, df_def)
   
  return(list(df = df, df_def = df_def))
}
 
load("expand_nb_data.Rdata")
smp_list <- create_sample(nb_df, nb_df_def)
smp <- smp_list$df
smp_def <- smp_list$df_def
 
```
 
 
### Variable Definitions
 
```{r var_def}
 
kable(data.frame(Variable=smp_def$var_name, 
                 Definition=smp_def$var_def), 
      row.names = FALSE) %>%
  kable_styling()
 
```
 
 
### Sample Composition
 
```{r sample_composition}
 
df <- smp
df[, uc$bar_chart_var1] <- as.factor(df[, uc$bar_chart_var1])
if (uc$bar_chart_var2 != "None")
  df[, uc$bar_chart_var2] <- as.factor(df[, uc$bar_chart_var2])
if (uc$bar_chart_group_by != "All")
  df <- df[df[, uc$group_factor] == uc$bar_chart_group_by,]
if (!anyNA(suppressWarnings(as.numeric(as.character(df[, uc$bar_chart_var1])))))
  numeric_bar_chart_var1 <- as.numeric(as.character(df[, uc$bar_chart_var1]))
if (uc$bar_chart_var2 != "None" & (!uc$bar_chart_relative)) {
  p <- ggplot(df, aes(df[,uc$bar_chart_var1])) +
    geom_bar(aes(fill=df[,uc$bar_chart_var2]), position = "stack") +
    labs(x = uc$bar_chart_var1, fill = uc$bar_chart_var2)
} else {
  if (uc$bar_chart_var2 != "None") {
    p <- ggplot(df, aes(df[, uc$bar_chart_var1])) +
      geom_bar(aes(fill=df[, uc$bar_chart_var2]), position = "fill") +
      abs(x = uc$bar_chart_var1, fill = uc$bar_chart_var2, y = "Percent") +
      scale_y_continuous(labels = percent_format())
  } else {
    p <- ggplot(df, aes(df[,uc$bar_chart_var1])) +
      geom_bar() + labs(x = uc$bar_chart_var1)
  }
}
if (length(levels(df[,uc$bar_chart_var1])) > 10 &&
    !anyNA(suppressWarnings(as.numeric(as.character(df[, uc$bar_chart_var1])))))
  p <- p + scale_x_discrete(breaks = pretty(as.numeric(as.character(df[, uc$bar_chart_var1])), n = 10))
p
 
```
 
 
### Missing Values
 
```{r}
 
df <- smp
if (uc$missing_values_group_by != "All")
  df <- df[df[, uc$group_factor] == uc$missing_values_group_by,]
prepare_missing_values_graph(df, lts_id$name)
 
```
 
 
### Descriptive Statistics
 
```{r descriptive_statistics}
 
t <- prepare_descriptive_table(smp)
t$kable_ret  %>%
  kable_styling("condensed", full_width = F, position = "center")
 
```
 
 
### Histogram
 
```{r histogram}
 
if (uc$hist_group_by == "All") {
  hist(as.numeric(smp[, uc$hist_var]), main="", xlab = uc$hist_var, col="red", right = FALSE, breaks=uc$hist_nr_of_breaks)
} else {
  hist(as.numeric(smp[smp[, uc$group_factor] == uc$hist_group_by, uc$hist_var]), 
       main="", xlab = uc$hist_var, col="red", right=FALSE, breaks=uc$hist_nr_of_breaks)
}
 
```
 
 
### Extreme Observations
 
```{r extreme_observations}
 
vars <- c(lcs_id$name, lts_id$name, uc$ext_obs_var)
if (uc$group_factor != "None") vars <- c(vars, uc$group_factor)
df <- smp[, vars]
if (uc$ext_obs_period_by != "All")
  small_df <- df[small_df[, lts_id$name] == uc$ext_obs_period_by, ]
if (uc$ext_obs_group_by != "All")
  df <- small_df[df[, uc$group_factor] == uc$ext_obs_group_by, vars]
df <- droplevels(df[complete.cases(df),])
if (nrow(df) <= 10) {
  cat("Not enough data to generate table")
} else {
  tab <- prepare_ext_obs_table(df, var = uc$ext_obs_var)
  tab$kable_ret %>%
        kable_styling()
}
 
```
 
 
### By Group Bar Graph
 
```{r}
 
q25 <- function(x, na.rm) {quantile(x, 0.25, na.rm)}
q75 <- function(x, na.rm) {quantile(x, 0.75, na.rm)}
 
df <- smp
 
if (uc$bgbg_group_by == "All") {
  prepare_by_group_bar_graph(df[, c(uc$bgbg_byvar, uc$bgbg_var)],
                             uc$bgbg_byvar, uc$bgbg_var, get(uc$bgbg_stat), uc$bgbg_sort_by_stat)$plot +
    ylab(paste(uc$bgbg_stat, uc$bgbg_var))
} else {
 prepare_by_group_bar_graph(df[df[, uc$group_factor] == uc$bgbg_group_by, c(uc$bgbg_byvar, uc$bgbg_var)],
                             uc$bgbg_byvar, uc$bgbg_var, get(uc$bgbg_stat), uc$bgbg_sort_by_stat)$plot +
    ylab(paste(uc$bgbg_stat, uc$bgbg_var))
}
 
```
 
  
### By Group Violin Graph
 
```{r}
 
df <- smp
 
if (uc$bgvg_group_by == "All") {
  prepare_by_group_violin_graph(df[, c(uc$bgvg_byvar, uc$bgvg_var)],
                                uc$bgvg_byvar, uc$bgvg_var, uc$bgvg_sort_by_stat)
} else {
  prepare_by_group_violin_graph(df[df[, uc$group_factor] == uc$bgvg_group_by, c(uc$bgvg_byvar, uc$bgvg_var)],
                                uc$bgvg_byvar, uc$bgvg_var, uc$bgvg_sort_by_stat)
}
 
```
 
 
### Prepare Time Trend Graph
 
```{r time_trend_graph}
 
df <- smp
if (uc$trend_graph_group_by == "All") {
  varlist <- c(lts_id$name, uc$trend_graph_var1, uc$trend_graph_var2, uc$trend_graph_var3)
} else {
  varlist <- c(lts_id$name, uc$group_factor, uc$trend_graph_var1, uc$trend_graph_var2, uc$trend_graph_var3)
}
varlist <- varlist[! varlist %in% "None"]
df <- df[,varlist]
if (uc$trend_graph_group_by == "All") {
   p <- prepare_trend_graph(df, lts_id$name)
} else  p <- prepare_trend_graph(df[df[, uc$group_factor] == uc$trend_graph_group_by,-which(names(df) %in% uc$group_factor)], lts_id$name)
p$plot
 
```
 
 
### Prepare Quantile Time Trend Graph 
 
```{r quantile_time_trend_graph}
 
df <- smp
quantiles <- as.numeric(uc$quantile_trend_graph_quantiles)
if (uc$quantile_trend_graph_group_by == "All") {
   p <- prepare_quantile_trend_graph(df[, c(lts_id$name, uc$quantile_trend_graph_var)], lts_id$name, quantiles)
} else {
   p <- prepare_quantile_trend_graph(df[df[, uc$group_factor] == uc$quantile_trend_graph_group_by,
                                  c(lts_id$name, uc$quantile_trend_graph_var)], lts_id$name, quantiles)
}
p$plot
 
```
 
 
### Correlation Graph
 
```{r corr_graph}
 
df <- smp
if (uc$corrplot_group_by != "All") df <- df[df[, uc$group_factor] == uc$corrplot_group_by,]
vars <- which(sapply(df, function(x) all(is.numeric(x) | is.logical(x))))
vars <- vars[vars %in% which(!sapply(df, function(x) all(is.na(x))))]
vars <- vars[vars %in% which(!sapply(df, function(x) (all(duplicated(x)[-1]))))]
ret <- prepare_correlation_graph(df[, vars])
 
```
 
 
### Scatter Plot
 
```{r}
 
scatter_df <- smp
if (uc$scatter_group_by != "All")
  scatter_df <- scatter_df[scatter_df[, uc$group_factor] == uc$scatter_group_by,]
varlist <- c(lcs_id$name, lts_id$name,
             uc$scatter_x, uc$scatter_y, uc$scatter_color, uc$scatter_size)
scatter_df <- scatter_df[,varlist[!grepl("None", varlist)]]
scatter_df <- scatter_df[complete.cases(scatter_df),]
if (uc$scatter_color %in% lfactor$name) scatter_df[,uc$scatter_color] <- as.factor(scatter_df[,uc$scatter_color])
if (uc$scatter_sample & (nrow(scatter_df) > 1000)) {
  set.seed(42)
  scatter_df <- dplyr::sample_n(scatter_df, 1000)
}
scatter_color <- ifelse(uc$scatter_color == "None", "", uc$scatter_color)
scatter_size <- ifelse(uc$scatter_size == "None", "", uc$scatter_size)
scatter_loess <- ifelse(uc$scatter_loess, 1, 0)
prepare_scatter_plot(scatter_df, uc$scatter_x, uc$scatter_y,
                             scatter_color, scatter_size, scatter_loess)
 
```
 
 
### Regression Table
 
```{r}
  
varlist <- c(uc$reg_y, uc$reg_x, uc$reg_fe1, uc$reg_fe2, uc$reg_by)
varlist <- varlist[!varlist %in% "None"]
df <- smp[,varlist]
if (uc$reg_by != "None") df[, uc$reg_by] <- as.factor(df[, uc$reg_by])
if (!uc$reg_y %in% c(lnumeric$name, llogical$name)) df[, uc$reg_y] <- as.factor(df[, uc$reg_y])
df <- droplevels(df[complete.cases(df),])
 
feffect <- ""
if (uc$reg_fe1 != "None") {
  feffect <- uc$reg_fe1
  if (uc$reg_fe2 != "None") feffect <- c(feffect, uc$reg_fe2)
} else if (uc$reg_fe2 != "None") feffect <- uc$reg_fe2 
cluster <- ""
if (uc$cluster == 2) cluster <- uc$reg_fe1
if (uc$cluster == 3) cluster <- uc$reg_fe2
if (uc$cluster == 4) cluster <- c(uc$reg_fe1, uc$reg_fe2)
cluster <- cluster[!cluster %in% "None"]
reg_by <- ifelse(uc$reg_by != "None", uc$reg_by, "")
t <- prepare_regression_table(df = df, dvs = uc$reg_y, idvs = uc$reg_x,
                              feffects = feffect, clusters = cluster,
                              models = uc$model, byvar = reg_by)
HTML(t$table)
 
```
 
 
### Note
 
This Notebook has been automatically generated using the [ExPanDaR](https://joachim-gassen.github.io/ExPanDaR) package.
